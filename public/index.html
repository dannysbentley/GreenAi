<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gemini AI - Sustainability Evaluation</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <nav>
      <div class="logo">dwp | Sustainability AI</div>
    </nav>
  </header>

  <main>
    <section id="upload">
      <h2>Upload Your Project</h2>
      <p>Describe your project & upload an image or presentation PDF for sustainability evaluation by AI.</p>
      <form id="upload-form">
        <textarea id="user-description" rows="5" placeholder="Provide a brief project description..."></textarea>
        <div class="file-upload-container">
          <label for="file-upload" class="custom-file-upload">Choose Files</label>
          <span class="file-name">No files chosen</span>
          <input type="file" id="file-upload" accept="image/*,application/pdf" multiple>
        </div>
        <button id="upload-button" type="button">Submit</button>
      </form>
      <div id="response-container"></div>
    </section>

    <section id="features">
      <div class="features-grid">
        <div class="feature">
          <h3>Easy Upload</h3>
          <p>Upload PDF or Image of your project design.</p>
        </div>
        <div class="feature">
          <h3>AI Assessment</h3>
          <p>Automated checklist-based sustainability reviews tailored to your projects.</p>
        </div>
        <div class="feature">
          <h3>Email Report</h3>
          <p>Generate and send reports via email.</p>
        </div>
      </div>
    </section>
    
    <footer>
      <p>&copy; 2024 dwp | Sustainability AI. All rights reserved.</p>
    </footer>
  </main>

  <script>
    // Update the displayed file names when files are selected
    document.getElementById("file-upload").addEventListener("change", function () {
      const fileNames = Array.from(this.files).map(file => file.name).join(", ") || "No files chosen";
      document.querySelector(".file-name").textContent = fileNames;
    });

    document.getElementById("upload-button").addEventListener("click", async () => {
      const description = document.getElementById("user-description").value.trim();
      const files = document.getElementById("file-upload").files;
      const responseContainer = document.getElementById("response-container");

      // Basic validations
      if (!files.length || !description) {
        responseContainer.textContent = "Please provide both a description and at least one file.";
        return;
      }
      if (!description.toLowerCase().startsWith("dwp")) {
        responseContainer.textContent = "Submission rejected. Description must start with 'dwp'.";
        return;
      }

      // Filter to images/PDFs
      const allowedFiles = Array.from(files).filter(file =>
        file.type.startsWith("image/") || file.type === "application/pdf"
      );
      if (!allowedFiles.length) {
        responseContainer.textContent = "No valid image or PDF files selected.";
        return;
      }

      responseContainer.textContent = "Uploading files to Cloud Storage...";

      try {
        // 1) For each file, request a signed URL and upload via PUT
        const uploadedFilenames = [];
        for (const file of allowedFiles) {
          // Create a unique filename to avoid collisions
          const uniqueName = `${Date.now()}-${file.name}`;

          // Request a signed URL from your backend
          const response = await fetch("/get-upload-url", {
            method: "POST", 
            headers: { "Content-Type": "application/json" }, 
            body: JSON.stringify({ filename: file.name }) // or a unique name
            });
            const { uploadUrl } = await response.json();

          if (!uploadUrl) {
            throw new Error("Failed to get signed upload URL.");
          }

          // Upload the file directly to Cloud Storage via the signed URL
          await fetch(uploadUrl, {
            method: 'PUT',
            headers: { "Content-Type": file.type },
            body: file
          });

          // Keep track of which filenames we've uploaded
          uploadedFilenames.push(uniqueName);
        }

        const response = await fetch("/process-gemini", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            filename: uniqueFilename, // The same name used during the GCS upload
            description: "dwp my project description..."
          })
        });
        
        const data = await response.json();
        console.log("Gemini reply:", data.reply);

        // For now, just show success
        responseContainer.textContent = `Uploaded files: ${uploadedFilenames.join(", ")}`;
      } catch (error) {
        console.error("Error:", error);
        responseContainer.textContent = "An error occurred while uploading. Please try again.";
      }
    });
  </script>
</body>
</html>